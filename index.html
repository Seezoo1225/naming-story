<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>名前ストーリー診断</title>
  <meta name="color-scheme" content="light">
  <style>
    :root{
      --edo: #4b0082;           /* 江戸紫（主色） */
      --edo-50:#f5f0fb;
      --line:#e7e2ee;
      --ok:#1e8d3e;
      --warn:#b66a00;
      --bad:#a10d3a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:#333; background:#f8f6fb;
      font-family: "Hiragino Kaku Gothic ProN", Meiryo, system-ui, -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    header{
      background:var(--edo); color:#fff; padding:28px 16px; text-align:center;
    }
    header h1{margin:0 0 6px 0; font-size: clamp(22px, 3.2vw, 34px);}
    header p{margin:0; opacity:.9; letter-spacing:.06em}

    main{max-width: 1050px; margin: 28px auto; padding: 0 16px;}

    /* 入力カード */
    .panel{
      background:#fff; border-radius:12px; padding:16px;
      box-shadow: 0 4px 14px rgba(0,0,0,.06);
      border:1px solid var(--line);
    }
    .row{display:grid; grid-template-columns: 1fr; gap:12px}
    @media(min-width:700px){
      .row{grid-template-columns: 1fr 200px 1fr}
    }
    label{font-size:14px; color:#5a5270}
    input, select{
      width:100%; padding:10px 12px; font-size:16px; border-radius:8px;
      border:1px solid #d7d0df; background:#fff;
    }
    .checkline{display:flex; align-items:center; gap:8px; margin-top:6px; color:#574a7a; font-size:14px}
    button.primary{
      width:100%; margin-top:12px; padding:14px 18px; font-size:16px; font-weight:600;
      color:#fff; background:var(--edo); border:0; border-radius:9px; cursor:pointer;
    }
    button.primary:hover{opacity:.92}
    .muted{color:#766e8e; font-size:13px; margin-top:6px}

    /* カードグリッド（横並び） */
    .cards{
      margin-top:20px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap:18px;
    }
    .card{
      background:#fff; border-radius:12px; padding:16px;
      border:1px solid var(--line);
      box-shadow: 0 2px 10px rgba(0,0,0,.05);
      display:flex; flex-direction:column; gap:10px;
    }
    .name{font-size:22px; color:var(--edo); margin:0}
    .reading{margin:0; font-size:14px; color:#6b6480}
    .copy{margin:6px 0 0 0; font-style:italic; color:#4a3e6b}
    .story{margin:0; line-height:1.75}

    table{
      width:100%; border-collapse:collapse; margin-top:4px; font-size:14px;
      border:1px solid var(--line); border-radius:10px; overflow:hidden;
    }
    th,td{border:1px solid var(--line); padding:8px; text-align:center;}
    th{background:#f5f0fb; color:#4a3e6b; font-weight:600}
    .subttl{margin:14px 0 6px 0; font-size:15px; color:#5a5270; font-weight:700}

    /* 運勢バッジ（色分けを明確に） */
    .pill{display:inline-block; padding:.25rem .55rem; border-radius:999px; font-size:12px; border:1px solid #ddd}
    .pill.daikichi { background:#ffe8e8; color:#c01818; border-color:#ffcaca; } /* 大吉=赤 */
    .pill.chukichi { background:#fff2df; color:#b66a00; border-color:#ffd9a8; } /* 中吉=オレンジ */
    .pill.kichi    { background:#eaf7ef; color:#1e8d3e; border-color:#cdebd6; } /* 吉=緑 */
    .pill.shokichi { background:#fffbe6; color:#7a6a00; border-color:#f1e9b3; } /* 小吉=黄 */
    .pill.kyou     { background:#f8e8ef; color:#a10d3a; border-color:#f2c1d2; } /* 凶=えんじ */
    .pill.daikyou  { background:#ffe1e6; color:#8e001a; border-color:#ffb9c6; } /* 大凶=濃い赤 */

    /* ボタン群 */
    .actions{display:flex; gap:8px; margin-top:4px}
    .btn{border:1px solid #d7d0df; background:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:13px}
    .btn:hover{background:#faf7ff}

    /* 五格説明 */
    .legend{
      margin-top:24px; font-size:13px; color:#5a5270;
      display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:12px;
    }
    .legend .box{background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px}

    /* ステータス */
    #status{margin: 16px 0 4px 0; font-size:14px; color:#6b6480}
  </style>
</head>
<body>
  <header>
    <h1>名前ストーリー診断</h1>
    <p>AI × 姓名判断 × ストーリー</p>
  </header>

  <main>
    <!-- 入力 -->
    <div class="panel">
      <div class="row">
        <div>
          <label for="surname">苗字</label>
          <input id="surname" placeholder="例: 山田" />
        </div>
        <div>
          <label for="gender">性別</label>
          <select id="gender">
            <option value="unknown">どちらでも</option>
            <option value="male">男性</option>
            <option value="female">女性</option>
          </select>
        </div>
        <div>
          <label for="concept">希望イメージ</label>
          <input id="concept" placeholder="例: 未来 / 光 / 読みやすさ重視" />
        </div>
      </div>
      <label class="checkline">
        <input id="debugMode" type="checkbox"> デバッグモード（ダミー結果を返す）
      </label>
      <button class="primary" onclick="generate()">無料で診断する</button>
      <div id="status" class="muted"></div>
    </div>

    <!-- 結果 -->
    <div id="results" class="cards"></div>

    <!-- 五格の簡易説明 -->
    <div class="legend">
      <div class="box"><b>天格</b>…先祖・家柄の運。姓の合計画。</div>
      <div class="box"><b>人格</b>…性格・主運。姓の最後＋名の最初。</div>
      <div class="box"><b>地格</b>…若年期の運。名の合計画。</div>
      <div class="box"><b>外格</b>…対人運・外向き。総格 − 人格。</div>
      <div class="box"><b>総格</b>…晩年期や総合的な流れ。姓名の総画。</div>
    </div>
  </main>

  <script>
    // 便利関数
    const textOrDash = (v)=> (v===0 || v===null || v===undefined || v==="") ? "-" : v;

    // 運勢テキスト→バッジのクラス付け
    function luckToClass(s){
      const t = String(s||"");
      if (t.includes("大凶")) return "daikyou";
      if (t.includes("凶"))   return "kyou";
      if (t.includes("大吉")) return "daikichi";
      if (t.includes("中吉")) return "chukichi";
      if (t.includes("小吉")) return "shokichi";
      if (t.includes("吉"))   return "kichi";
      return "";
    }
    const luckBadge = (s) => {
      if(!s) return '<span class="pill">-</span>';
      const cls = luckToClass(s);
      return `<span class="pill ${cls}">${s}</span>`;
    };

    // breakdown を "山:3 / 田:5 / 太:4 / 志:3" のように
    function renderBreakdown(candidate){
      const bdSurname = candidate?.strokes?.surname?.breakdown || [];
      const bdGiven   = candidate?.strokes?.given?.breakdown || [];
      const bdBoth = Array.isArray(bdSurname) || Array.isArray(bdGiven)
        ? [...(bdSurname||[]), ...(bdGiven||[])]
        : (candidate?.strokes?.breakdown || []);
      if(!bdBoth.length) return "-";
      return bdBoth.map(b => Array.isArray(b) ? `${b[0]}:${b[1]}` : `${b.char||b[0]}:${b.count||b[1]}`).join(" / ");
    }

    function asText(candidate){
      const f = candidate?.fortune || {};
      const s = candidate?.strokes || {};
      const sSum = s?.surname?.total ?? s?.surnameTotal ?? "-";
      const gSum = s?.given?.total   ?? s?.givenTotal   ?? "-";
      const tSum = s?.total ?? "-";
      return [
        `【名前】${candidate.name}（読み: ${candidate.reading||"-"}）`,
        `【コピー】${candidate.copy||"-"}`,
        `【ストーリー】${candidate.story||"-"}`,
        `【五格】天:${textOrDash(f.tenkaku)} / 人:${textOrDash(f.jinkaku)} / 地:${textOrDash(f.chikaku)} / 外:${textOrDash(f.gaikaku)} / 総:${textOrDash(f.soukaku)}`,
        `【運勢】総合:${textOrDash(f?.luck?.overall)} / 仕事:${textOrDash(f?.luck?.work)} / 恋愛:${textOrDash(f?.luck?.love)} / 健康:${textOrDash(f?.luck?.health)}`,
        `【画数】姓:${textOrDash(sSum)} / 名:${textOrDash(gSum)} / 総画:${textOrDash(tSum)} / 内訳:${renderBreakdown(candidate)}`
      ].join("\n");
    }

    async function generate(){
      const surname = document.getElementById("surname").value.trim();
      const gender  = document.getElementById("gender").value;
      const concept = document.getElementById("concept").value.trim();
      const debug   = document.getElementById("debugMode").checked;
      const endpoint = debug ? "/api/generate?debug=1" : "/api/generate";

      if(!surname || !concept){
        alert("苗字と希望イメージを入力してください。");
        return;
      }

      const status = document.getElementById("status");
      const results = document.getElementById("results");
      status.textContent = "診断中…";
      results.innerHTML = "";

      try{
        const res = await fetch(endpoint,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ surname, gender, concept })
        });
        const data = await res.json();
        console.log("[/api/generate response]", data);

        if(!data || !Array.isArray(data.candidates)){
          status.textContent = "生成に失敗しました。";
          return;
        }

        results.innerHTML = data.candidates.map((c, idx) => {
          const f = c.fortune || {};
          const s = c.strokes || {};
          const sSum = s?.surname?.total ?? s?.surnameTotal ?? "-";
          const gSum = s?.given?.total   ?? s?.givenTotal   ?? "-";
          const tSum = s?.total ?? "-";
          const breakdown = renderBreakdown(c);

          return `
            <div class="card" data-idx="${idx}">
              <h3 class="name">${c.name || "-"}</h3>
              <p class="reading">読み：${textOrDash(c.reading)}</p>
              <p class="copy">${c.copy ? c.copy : ""}</p>
              <p class="story">${c.story ? c.story : ""}</p>

              <div class="subttl">姓名判断（推定）</div>
              <table>
                <tr><th>天格</th><td>${textOrDash(f.tenkaku)}</td><th>人格</th><td>${textOrDash(f.jinkaku)}</td></tr>
                <tr><th>地格</th><td>${textOrDash(f.chikaku)}</td><th>外格</th><td>${textOrDash(f.gaikaku)}</td></tr>
                <tr><th>総格</th><td>${textOrDash(f.soukaku)}</td><th>総合運</th><td>${luckBadge(f?.luck?.overall)}</td></tr>
                <tr><th>仕事運</th><td>${luckBadge(f?.luck?.work)}</td><th>恋愛運</th><td>${luckBadge(f?.luck?.love)}</td></tr>
                <tr><th>健康運</th><td>${luckBadge(f?.luck?.health)}</td><th>備考</th><td>${textOrDash(f.note)}</td></tr>
              </table>

              <div class="subttl">画数診断（推定）</div>
              <table>
                <tr><th>姓 合計</th><td>${textOrDash(sSum)}</td><th>名 合計</th><td>${textOrDash(gSum)}</td></tr>
                <tr><th>総画</th><td colspan="3">${textOrDash(tSum)}</td></tr>
                <tr><th>内訳</th><td colspan="3">${breakdown}</td></tr>
              </table>

              <div class="actions">
                <button class="btn" onclick="copyCard(${idx})">この候補をコピー</button>
              </div>
            </div>
          `;
        }).join("");

        status.textContent = debug ? "（デバッグモード）ダミー結果を表示中。" : "生成完了。";
        window.__lastCandidates = data.candidates;

      }catch(err){
        console.error(err);
        status.textContent = "サーバエラーが発生しました。時間をおいて再度お試しください。";
      }
    }

    function copyCard(idx){
      const cand = (window.__lastCandidates || [])[idx];
      if(!cand){ return; }
      const text = asText(cand);
      navigator.clipboard.writeText(text).then(()=>{
        alert("候補をクリップボードへコピーしました。");
      }).catch(()=>{
        prompt("以下をコピーしてください：", text);
      });
    }
  </script>
</body>
</html>

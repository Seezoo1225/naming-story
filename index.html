<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>åå‰ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è¨ºæ–­</title>
  <meta name="color-scheme" content="light">
  <style>
    :root{
      --edo: #4b0082;           /* æ±Ÿæˆ¸ç´«ï¼ˆä¸»è‰²ï¼‰ */
      --edo-50:#f5f0fb;
      --line:#e7e2ee;
      --ok:#1e8d3e;
      --warn:#b66a00;
      --bad:#a10d3a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:#333; background:#f8f6fb;
      font-family: "Hiragino Kaku Gothic ProN", Meiryo, system-ui, -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    header{
      background:var(--edo); color:#fff; padding:28px 16px; text-align:center;
    }
    header h1{margin:0 0 6px 0; font-size: clamp(22px, 3.2vw, 34px);}
    header p{margin:0; opacity:.9; letter-spacing:.06em}

    main{max-width: 1050px; margin: 28px auto; padding: 0 16px;}

    /* å…¥åŠ›ã‚«ãƒ¼ãƒ‰ */
    .panel{
      background:#fff; border-radius:12px; padding:16px;
      box-shadow: 0 4px 14px rgba(0,0,0,.06);
      border:1px solid var(--line);
    }
    .row{display:grid; grid-template-columns: 1fr; gap:12px}
    @media(min-width:700px){
      .row{grid-template-columns: 1fr 200px 1fr}
    }
    label{font-size:14px; color:#5a5270}
    input, select{
      width:100%; padding:10px 12px; font-size:16px; border-radius:8px;
      border:1px solid #d7d0df; background:#fff;
    }
    .checkline{display:flex; align-items:center; gap:8px; margin-top:6px; color:#574a7a; font-size:14px}
    button.primary{
      width:100%; margin-top:12px; padding:14px 18px; font-size:16px; font-weight:600;
      color:#fff; background:var(--edo); border:0; border-radius:9px; cursor:pointer;
    }
    button.primary:hover{opacity:.92}
    .muted{color:#766e8e; font-size:13px; margin-top:6px}

    /* ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ï¼ˆæ¨ªä¸¦ã³ï¼‰ */
    .cards{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap:18px;
    }
    .card{
      background:#fff; border-radius:12px; padding:16px;
      border:1px solid var(--line);
      box-shadow: 0 2px 10px rgba(0,0,0,.05);
      display:flex; flex-direction:column; gap:10px;
    }
    .name{font-size:22px; color:var(--edo); margin:0}
    .reading{margin:0; font-size:14px; color:#6b6480}
    .copy{margin:6px 0 0 0; font-style:italic; color:#4a3e6b}
    .story{margin:0; line-height:1.85; white-space:pre-line;} /* æ®µè½é¢¨ */

    table{
      width:100%; border-collapse:collapse; margin-top:4px; font-size:14px;
      border:1px solid var(--line); border-radius:10px; overflow:hidden;
    }
    th,td{border:1px solid var(--line); padding:8px; text-align:center;}
    th{background:#f5f0fb; color:#4a3e6b; font-weight:600}
    .subttl{margin:14px 0 6px 0; font-size:15px; color:#5a5270; font-weight:700}

    /* é‹å‹¢ãƒãƒƒã‚¸ï¼ˆè‰²åˆ†ã‘ï¼‰ */
    .pill{display:inline-block; padding:.25rem .55rem; border-radius:999px; font-size:12px; border:1px solid #ddd}
    .pill.daikichi { background:#ffe8e8; color:#c01818; border-color:#ffcaca; } /* å¤§å‰=èµ¤ */
    .pill.chukichi { background:#fff2df; color:#b66a00; border-color:#ffd9a8; } /* ä¸­å‰=ã‚ªãƒ¬ãƒ³ã‚¸ */
    .pill.kichi    { background:#eaf7ef; color:#1e8d3e; border-color:#cdebd6; } /* å‰=ç·‘ */
    .pill.shokichi { background:#fffbe6; color:#7a6a00; border-color:#f1e9b3; } /* å°å‰=é»„ */
    .pill.kyou     { background:#f8e8ef; color:#a10d3a; border-color:#f2c1d2; } /* å‡¶=ãˆã‚“ã˜ */
    .pill.daikyou  { background:#ffe1e6; color:#8e001a; border-color:#ffb9c6; } /* å¤§å‡¶=æ¿ƒã„èµ¤ */

    /* ãƒœã‚¿ãƒ³ç¾¤ */
    .actions{display:flex; gap:8px; margin-top:4px}
    .btn{border:1px solid #d7d0df; background:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:13px}
    .btn:hover{background:#faf7ff}

    /* äº”æ ¼èª¬æ˜ */
    .legend{
      margin-top:18px; font-size:13px; color:#5a5270;
      display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:12px;
    }
    .legend .box{background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px}

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ & æµæ´¾è¡¨è¨˜ */
    #status{margin: 12px 0 0 0; font-size:14px; color:#6b6480}
    #policyLine{margin: 6px 0 0 0; font-size:13px; color:#6b6480}
  </style>
</head>
<body>
  <header>
    <h1>åå‰ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è¨ºæ–­</h1>
    <p>AI Ã— å§“ååˆ¤æ–­ Ã— ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</p>
  </header>

  <main>
    <!-- å…¥åŠ› -->
    <div class="panel">
      <div class="row">
        <div>
          <label for="surname">è‹—å­—</label>
          <input id="surname" placeholder="ä¾‹: å±±ç”°" />
        </div>
        <div>
          <label for="gender">æ€§åˆ¥</label>
          <select id="gender">
            <option value="unknown">ã©ã¡ã‚‰ã§ã‚‚</option>
            <option value="male">ç”·æ€§</option>
            <option value="female">å¥³æ€§</option>
          </select>
        </div>
        <div>
          <label for="concept">å¸Œæœ›ã‚¤ãƒ¡ãƒ¼ã‚¸</label>
          <input id="concept" placeholder="ä¾‹: æœªæ¥ / å…‰ / èª­ã¿ã‚„ã™ã•é‡è¦–" />
        </div>
      </div>
      <label class="checkline">
        <input id="debugMode" type="checkbox"> ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ€ãƒŸãƒ¼çµæœã‚’è¿”ã™ï¼‰
      </label>
      <button class="primary" onclick="generate()">ç„¡æ–™ã§è¨ºæ–­ã™ã‚‹</button>
      <div id="status" class="muted"></div>
      <div id="policyLine" class="muted"></div>
    </div>

    <!-- çµæœ -->
    <div id="results" class="cards"></div>

    <!-- äº”æ ¼ã®ç°¡æ˜“èª¬æ˜ -->
    <div class="legend">
      <div class="box"><b>å¤©æ ¼</b>â€¦å…ˆç¥–ãƒ»å®¶æŸ„ã®é‹ã€‚å§“ã®åˆè¨ˆç”»ã€‚</div>
      <div class="box"><b>äººæ ¼</b>â€¦æ€§æ ¼ãƒ»ä¸»é‹ã€‚å§“ã®æœ€å¾Œï¼‹åã®æœ€åˆã€‚</div>
      <div class="box"><b>åœ°æ ¼</b>â€¦è‹¥å¹´æœŸã®é‹ã€‚åã®åˆè¨ˆç”»ã€‚</div>
      <div class="box"><b>å¤–æ ¼</b>â€¦å¯¾äººé‹ãƒ»å¤–å‘ãã€‚ç·æ ¼ âˆ’ äººæ ¼ã€‚</div>
      <div class="box"><b>ç·æ ¼</b>â€¦æ™©å¹´æœŸã‚„ç·åˆçš„ãªæµã‚Œã€‚å§“åã®ç·ç”»ã€‚</div>
    </div>
  </main>

  <script>
    // ä¾¿åˆ©é–¢æ•°
    const textOrDash = (v)=> (v===0 || v===null || v===undefined || v==="") ? "-" : v;

    // é‹å‹¢ãƒ†ã‚­ã‚¹ãƒˆâ†’ãƒãƒƒã‚¸ã®ã‚¯ãƒ©ã‚¹ä»˜ã‘
    function luckToClass(s){
      const t = String(s||"");
      if (t.includes("å¤§å‡¶")) return "daikyou";
      if (t.includes("å‡¶"))   return "kyou";
      if (t.includes("å¤§å‰")) return "daikichi";
      if (t.includes("ä¸­å‰")) return "chukichi";
      if (t.includes("å°å‰")) return "shokichi";
      if (t.includes("å‰"))   return "kichi";
      return "";
    }
    const luckBadge = (s) => {
      if(!s) return '<span class="pill">-</span>';
      const cls = luckToClass(s);
      return `<span class="pill ${cls}">${s}</span>`;
    };

    // æ®µè½åŒ–ï¼ˆã€Œã€‚ã€ã§ã»ã©ã‚ˆãæ”¹è¡Œï¼‰â†’ è¦‹ã‚„ã™ã„æ®µè½é¢¨
    function paragraphize(str){
      if(!str) return "";
      const s = String(str).replace(/\s+/g,"");
      const parts = s.split(/(?<=ã€‚)/);
      const chunks = [];
      let buf = "";
      for(const p of parts){
        if((buf + p).length > 60){ chunks.push(buf); buf = p; }
        else { buf += p; }
      }
      if(buf) chunks.push(buf);
      return chunks.join("\n\n"); // white-space:pre-line ã§æ®µè½è¡¨ç¤º
    }

    // breakdown ã‚’ "å±±:3 / ç”°:5 / å¤ª:4 / å¿—:3" ã®ã‚ˆã†ã«
    function renderBreakdown(candidate){
      const bdSurname = candidate?.strokes?.surname?.breakdown || [];
      const bdGiven   = candidate?.strokes?.given?.breakdown || [];
      const bdBoth = Array.isArray(bdSurname) || Array.isArray(bdGiven)
        ? [...(bdSurname||[]), ...(bdGiven||[])]
        : (candidate?.strokes?.breakdown || []);
      if(!bdBoth.length) return "-";
      return bdBoth.map(b => Array.isArray(b) ? `${b[0]}:${b[1]}` : `${b.char||b[0]}:${b.count||b[1]}`).join(" / ");
    }

    function asText(candidate){
      const f = candidate?.fortune || {};
      const s = candidate?.strokes || {};
      const sSum = s?.surname?.total ?? s?.surnameTotal ?? "-";
      const gSum = s?.given?.total   ?? s?.givenTotal   ?? "-";
      const tSum = s?.total ?? "-";
      return [
        `ã€åå‰ã€‘${candidate.name}ï¼ˆèª­ã¿: ${candidate.reading||"-"}ï¼‰`,
        `ã€ã‚³ãƒ”ãƒ¼ã€‘${candidate.copy||"-"}`,
        `ã€ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã€‘${(candidate.story||"-").replace(/\s+$/,"")}`,
        `ã€äº”æ ¼ã€‘å¤©:${textOrDash(f.tenkaku)} / äºº:${textOrDash(f.jinkaku)} / åœ°:${textOrDash(f.chikaku)} / å¤–:${textOrDash(f.gaikaku)} / ç·:${textOrDash(f.soukaku)}`,
        `ã€é‹å‹¢ã€‘ç·åˆ:${textOrDash(f?.luck?.overall)} / ä»•äº‹:${textOrDash(f?.luck?.work)} / æ‹æ„›:${textOrDash(f?.luck?.love)} / å¥åº·:${textOrDash(f?.luck?.health)}`,
        `ã€ç”»æ•°ã€‘å§“:${textOrDash(sSum)} / å:${textOrDash(gSum)} / ç·ç”»:${textOrDash(tSum)} / å†…è¨³:${renderBreakdown(candidate)}`
      ].join("\n");
    }

    async function generate(){
      const surname = document.getElementById("surname").value.trim();
      const gender  = document.getElementById("gender").value;
      const concept = document.getElementById("concept").value.trim();
      const debug   = document.getElementById("debugMode").checked;
      const endpoint = debug ? "/api/generate?debug=1" : "/api/generate";

      if(!surname || !concept){
        alert("è‹—å­—ã¨å¸Œæœ›ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const status = document.getElementById("status");
      const policyLine = document.getElementById("policyLine");
      const results = document.getElementById("results");
      status.textContent = "è¨ºæ–­ä¸­â€¦";
      policyLine.textContent = "";
      results.innerHTML = "";

      try{
        const res = await fetch(endpoint,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ surname, gender, concept })
        });
        const data = await res.json();
        console.log("[/api/generate response]", data);

        if(!data || !Array.isArray(data.candidates)){
          status.textContent = "ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
          return;
        }

        // æµæ´¾/è¨ˆç®—æ–¹å¼ã‚’è¡¨ç¤ºï¼ˆãªã‘ã‚Œã°äº”æ ¼æ³•ï¼‰
        const ryuha = data?.policy?.ryuha || "äº”æ ¼æ³•ï¼ˆæ–°å­—ä½“ãƒ»éœŠæ•°ãªã—ï¼‰";
        const notes = data?.policy?.notes || "ç¾ä»£çš„ã§èª­ã¿ã‚„ã™ã„è¡¨è¨˜ã‚’å„ªå…ˆ";
        policyLine.textContent = `æµæ´¾/è¨ˆç®—æ–¹å¼ï¼š${ryuha} ï¼ æ–¹é‡ï¼š${notes}`;

        results.innerHTML = data.candidates.map((c, idx) => {
          const f = c.fortune || {};
          const s = c.strokes || {};
          const sSum = s?.surname?.total ?? s?.surnameTotal ?? "-";
          const gSum = s?.given?.total   ?? s?.givenTotal   ?? "-";
          const tSum = s?.total ?? "-";
          const breakdown = renderBreakdown(c);

          return `
            <div class="card" data-idx="${idx}">
              <h3 class="name">${c.name || "-"}</h3>
              <p class="reading">èª­ã¿ï¼š${textOrDash(c.reading)}</p>
              <p class="copy">${c.copy ? c.copy : ""}</p>
              <p class="story">${paragraphize(c.story)}</p>

              <div class="subttl">å§“ååˆ¤æ–­ï¼ˆæ¨å®šï¼‰</div>
              <table>
                <tr><th>å¤©æ ¼</th><td>${textOrDash(f.tenkaku)}</td><th>äººæ ¼</th><td>${textOrDash(f.jinkaku)}</td></tr>
                <tr><th>åœ°æ ¼</th><td>${textOrDash(f.chikaku)}</td><th>å¤–æ ¼</th><td>${textOrDash(f.gaikaku)}</td></tr>
                <tr><th>ç·æ ¼</th><td>${textOrDash(f.soukaku)}</td><th>ç·åˆé‹</th><td>${luckBadge(f?.luck?.overall)}</td></tr>
                <tr><th>ğŸ’¼ ä»•äº‹é‹</th><td>${luckBadge(f?.luck?.work)}</td><th>â¤ï¸ æ‹æ„›é‹</th><td>${luckBadge(f?.luck?.love)}</td></tr>
                <tr><th>ğŸŒ¸ å¥åº·é‹</th><td>${luckBadge(f?.luck?.health)}</td><th>å‚™è€ƒ</th><td>${textOrDash(f.note)}</td></tr>
              </table>

              <div class="subttl">ç”»æ•°è¨ºæ–­ï¼ˆæ¨å®šï¼‰</div>
              <table>
                <tr><th>å§“ åˆè¨ˆ</th><td>${textOrDash(sSum)}</td><th>å åˆè¨ˆ</th><td>${textOrDash(gSum)}</td></tr>
                <tr><th>ç·ç”»</th><td colspan="3">${textOrDash(tSum)}</td></tr>
                <tr><th>å†…è¨³</th><td colspan="3">${breakdown}</td></tr>
              </table>

              <div class="actions">
                <button class="btn" onclick="copyCard(${idx})">ã“ã®å€™è£œã‚’ã‚³ãƒ”ãƒ¼</button>
              </div>
            </div>
          `;
        }).join("");

        status.textContent = debug ? "ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰ãƒ€ãƒŸãƒ¼çµæœã‚’è¡¨ç¤ºä¸­ã€‚" : "ç”Ÿæˆå®Œäº†ã€‚";
        window.__lastCandidates = data.candidates;

      }catch(err){
        console.error(err);
        status.textContent = "ã‚µãƒ¼ãƒã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
      }
    }

    function copyCard(idx){
      const cand = (window.__lastCandidates || [])[idx];
      if(!cand){ return; }
      const text = asText(cand);
      navigator.clipboard.writeText(text).then(()=>{
        alert("å€™è£œã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
      }).catch(()=>{
        prompt("ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼š", text);
      });
    }
  </script>
</body>
</html>

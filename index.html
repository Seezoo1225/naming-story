<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>åå‰ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è¨ºæ–­</title>
<meta name="color-scheme" content="light">
<style>
  :root{
    --edo:#4b0082; --edo-50:#f5f0fb; --line:#e7e2ee;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#f8f6fb;color:#333;font-family:"Hiragino Kaku Gothic ProN",Meiryo,system-ui,-apple-system,sans-serif;-webkit-font-smoothing:antialiased}
  header{background:var(--edo);color:#fff;text-align:center;padding:28px 16px}
  header h1{margin:0 0 6px;font-size:clamp(22px,3.2vw,34px)}
  header p{margin:0;opacity:.9;letter-spacing:.06em}
  main{max-width:1050px;margin:28px auto;padding:0 16px}
  .panel{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);padding:16px}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:700px){.row{grid-template-columns:1fr 200px 1fr}}
  label{font-size:14px;color:#5a5270}
  input,select{width:100%;padding:10px 12px;font-size:16px;border-radius:8px;border:1px solid #d7d0df;background:#fff}
  .checkline{display:flex;align-items:center;gap:8px;margin-top:6px;color:#574a7a;font-size:14px}
  button.primary{width:100%;margin-top:12px;padding:14px 18px;font-size:16px;font-weight:600;color:#fff;background:var(--edo);border:0;border-radius:9px;cursor:pointer}
  button.primary:hover{opacity:.92}
  .muted{color:#766e8e;font-size:13px;margin-top:6px}
  .cards{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.05);padding:16px;display:flex;flex-direction:column;gap:10px}
  .name{font-size:22px;color:var(--edo);margin:0}
  .reading{margin:0;font-size:14px;color:#6b6480}
  .copy{margin:6px 0 0;font-style:italic;color:#4a3e6b}
  .story{margin:0;line-height:1.85;white-space:pre-line}
  table{width:100%;border-collapse:collapse;margin-top:4px;font-size:14px;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  th,td{border:1px solid var(--line);padding:8px;text-align:center}
  th{background:#f5f0fb;color:#4a3e6b;font-weight:600}
  .subttl{margin:14px 0 6px;font-size:15px;color:#5a5270;font-weight:700}
  .pill{display:inline-block;padding:.25rem .55rem;border-radius:999px;font-size:12px;border:1px solid #ddd}
  .pill.daikichi{background:#ffe8e8;color:#c01818;border-color:#ffcaca}
  .pill.chukichi{background:#fff2df;color:#b66a00;border-color:#ffd9a8}
  .pill.kichi{background:#eaf7ef;color:#1e8d3e;border-color:#cdebd6}
  .pill.shokichi{background:#fffbe6;color:#7a6a00;border-color:#f1e9b3}
  .pill.kyou{background:#f8e8ef;color:#a10d3a;border-color:#f2c1d2}
  .pill.daikyou{background:#ffe1e6;color:#8e001a;border-color:#ffb9c6}
  .actions{display:flex;gap:8px;margin-top:4px}
  .btn{border:1px solid #d7d0df;background:#fff;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px}
  .btn:hover{background:#faf7ff}
  .legend{margin-top:18px;font-size:13px;color:#5a5270;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
  .legend .box{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px}
  #status{margin:12px 0 0;font-size:14px;color:#6b6480}
  #policyLine{margin:6px 0 0;font-size:13px;color:#6b6480}
</style>
</head>
<body>
<header>
  <h1>åå‰ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è¨ºæ–­</h1>
  <p>AI Ã— å§“ååˆ¤æ–­ Ã— ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</p>
</header>

<main>
  <div class="panel">
    <div class="row">
      <div>
        <label for="surname">è‹—å­—</label>
        <input id="surname" placeholder="ä¾‹: å±±ç”°" />
      </div>
      <div>
        <label for="gender">æ€§åˆ¥</label>
        <select id="gender">
          <option value="unknown">ã©ã¡ã‚‰ã§ã‚‚</option>
          <option value="male">ç”·æ€§</option>
          <option value="female">å¥³æ€§</option>
        </select>
      </div>
      <div>
        <label for="concept">å¸Œæœ›ã‚¤ãƒ¡ãƒ¼ã‚¸</label>
        <input id="concept" placeholder="ä¾‹: æœªæ¥ / å…‰ / èª­ã¿ã‚„ã™ã•é‡è¦–" />
      </div>
    </div>
    <label class="checkline">
      <input id="debugMode" type="checkbox"> ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ€ãƒŸãƒ¼çµæœã‚’è¿”ã™ï¼‰
    </label>
    <button class="primary" onclick="generate()">ç„¡æ–™ã§è¨ºæ–­ã™ã‚‹</button>
    <div id="status" class="muted"></div>
    <div id="policyLine" class="muted"></div>
  </div>

  <div id="results" class="cards"></div>

  <div class="legend">
    <div class="box"><b>å¤©æ ¼</b>â€¦å…ˆç¥–ãƒ»å®¶æŸ„ã®é‹ã€‚å§“ã®åˆè¨ˆç”»ã€‚</div>
    <div class="box"><b>äººæ ¼</b>â€¦æ€§æ ¼ãƒ»ä¸»é‹ã€‚å§“ã®æœ€å¾Œï¼‹åã®æœ€åˆã€‚</div>
    <div class="box"><b>åœ°æ ¼</b>â€¦è‹¥å¹´æœŸã®é‹ã€‚åã®åˆè¨ˆç”»ã€‚</div>
    <div class="box"><b>å¤–æ ¼</b>â€¦å¯¾äººé‹ãƒ»å¤–å‘ãã€‚ç·æ ¼ âˆ’ äººæ ¼ã€‚</div>
    <div class="box"><b>ç·æ ¼</b>â€¦æ™©å¹´æœŸã‚„ç·åˆçš„ãªæµã‚Œã€‚å§“åã®ç·ç”»ã€‚</div>
  </div>
</main>

<script>
  /***********************
   * ç”»æ•°è¾æ›¸ï¼ˆæ–°å­—ä½“ãƒ»éœŠæ•°ãªã—ï¼‰
   * ã‚ˆãä½¿ã†åå‰æ¼¢å­—ã‚’ä¸­å¿ƒã«åéŒ²ã€‚
   * è¶³ã‚Šãªã„æ¼¢å­—ã¯ STROKES ã«è¿½è¨˜ã—ã¦ãã ã•ã„ã€‚
   ************************/
  const STROKES = {
    // åŸºæœ¬
    "ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5,"å…­":6,"ä¸ƒ":7,"å…«":8,"ä¹":9,"å":10,
    "äºº":2,"å­":3,"å¤§":3,"å°":3,"å¥³":3,"å±±":3,"å·":3,"å¿ƒ":4,"æ‰‹":4,"æ–‡":4,"å¤ª":4,"å¤©":4,
    "ä¸­":4,"æ°´":4,"æœ¨":4,"ç‹":4,"æ­£":5,"ç”Ÿ":5,"ç”°":5,"ç”±":5,"ç›®":5,"ç™½":5,"ç«‹":5,"æ°¸":5,"æœª":5,
    "å¤–":5,"æœ¬":5,"å¸":5,"åŠ ":5,"åŒ—":5,"å¤":5,"å³":5,"å·¦":5,"å":6,"å„":6,"å…‰":6,"åŒ":6,"å‘":6,"ç™¾":6,
    "æœ‰":6,"å®‰":6,"å®ˆ":6,"å‰":6,"æœ±":6,"æˆ":6,"ç¾Š":6,"ç¾":9, /* ä¸‹ã§ä¸Šæ›¸ãã‚ã‚Šã ãŒä¿é™º */
    "å…†":6,"æ¬¡":6,"å­":7,"å¸Œ":7,"å›":7,"æˆ":6,"æ¥":7,"å¤œ":8,"è°·":7,"é‡Œ":7,"è‰¯":7,"å’Œ":8,"ç›´":8,"é’":8,
    "éŸ³":9,"ç«œ":10,"é¾":16,

    // ã‚ˆãä½¿ã†åå‰æ¼¢å­—
    "æ„›":13,"è‘µ":12,"æ˜":8,"å½©":11,"æ­©":8,"é™½":12,"çµ":12,"å„ª":17,"æ‚ ":11,"å‹‡":9,"ä½‘":7,"ç¥":10,"å‹":4,
    "è£•":12,"å”¯":11,"ç”±":5,"æ‚ ":11,"é‡Œ":7,"è‰":10,"å‡›":15,"ç²":10,"è“®":13,"æ¶¼":11,"é¼":15,
    "å¥":11,"ç¿”":12,"å¸":5,"æµ·":9,"ç©º":8,"å®™":8,"å®‡":6,"æ˜Ÿ":9,"æ™´":12,"æ˜¥":9,"å¤":10,"ç§‹":9,"å†¬":5,
    "èŠ±":7,"è¯":10,"é¦™":9,"æ¡œ":10,"å’²":9,"èœ":11,"å¥ˆ":8,"é‚£":7,"çµ":12,"ç´—":10,"æ²™":7,"ç ":10,"çœŸ":10,
    "å®Ÿ":8,"ç¾":9,"èŠ½":8,"å„ª":17,"æ„›":13,"æ˜ ":9,"éŸ³":9,"å¥":9,"æ ":10,"å¿ƒ":4,"å¶":5,"æœ›":11,
    "å¸Œ":7,"ç¬‘":10,"å¯§":14,"å°Š":12,"å¿—":7,"å¿—":7,"å£«":3,"æ™º":12,"çŸ¥":8,"å¿ ":8,"ç›´":8,
    "å…‰":6,"è¼":15,"è²´":12,"è²´":12,"æ¡‚":10,"åœ­":6,"æ…§":15,"æµ":10,"æ…¶":15,"æ™¯":12,"æ™¯":12,
    "å¤§":3,"å¤ª":4,"æ±°":7,"æ±°":7,"æ‹“":8,"æ‹“":8,"åŒ ":6,"å°†":10,"å°†":10,"ç« ":11,"å½°":14,
    "å¥":11,"å‰›":10,"è±ª":14,"éƒ":9,"ç¿¼":17,"éš¼":10,"éš¼":10,"éš¼":10,"å¾¹":15,"æµ©":10,"èˆª":10,
    "æ¥“":13,"æ¤›":12,"æ¡‚":10,"æ¨¹":16,"æ¨º":14,"ç›´":8,"å°š":8,"çœŸ":10,"çœ":10,"æ…":13,
    "è¡":14,"ç·":14,"è’¼":13,"å£®":6,"å¥":9,"çˆ½":11,"ç„¶":12,"ç¦…":13,"æŸ“":9,"è’”":12,
    "å„ª":17,"é¥":13,"é™½":12,"çµ":12,"å’²":9,"èœ":11,"ç¾":9,"å½©":11,"ç²":10,"ç´¬":10,"è‘µ":12,"æ¥“":13,

    // ç”»æ•°ãŒè©±é¡Œã«ãªã‚Šã‚„ã™ã„
    "è¼”":14,"è¼":15,"è¼":15,"å¤§":3,"è¼":15,"å¥":11,"å’Œ":8,"æ¨¹":16,"å¤ª":4,"é›…":13,"ä½³":8,"ç›´":8,
    "æ‚ ":11,"é™½":12,"å„ª":17,"çµ":12,"èœ":11,"å’²":9,"ç¾":9,"é¬¼":10,"æŸ”":9,"æ „":9,"èŠ±":7,"å¥":9
  };

  // å¿µã®ãŸã‚é‡è¤‡ã‚­ãƒ¼æ•´ç†ï¼ˆåŒã‚­ãƒ¼æœ€å¾Œã®å€¤ãŒæ¡ç”¨ã•ã‚Œã‚‹ï¼‰

  const textOrDash = v => (v===0 || v===null || v===undefined || v==="") ? "-" : v;

  function luckToClass(s){
    const t = String(s||"");
    if (t.includes("å¤§å‡¶")) return "daikyou";
    if (t.includes("å‡¶"))   return "kyou";
    if (t.includes("å¤§å‰")) return "daikichi";
    if (t.includes("ä¸­å‰")) return "chukichi";
    if (t.includes("å°å‰")) return "shokichi";
    if (t.includes("å‰"))   return "kichi";
    return "";
  }
  const luckBadge = s => !s ? '<span class="pill">-</span>' : `<span class="pill ${luckToClass(s)}">${s}</span>`;

  // ã€Œã€‚ã€ã§ã»ã©ã‚ˆãæ®µè½åŒ–
  function paragraphize(str){
    if(!str) return "";
    const s = String(str).replace(/\s+/g,"");
    const parts = s.split(/(?<=ã€‚)/);
    const chunks = [];
    let buf = "";
    for(const p of parts){
      if((buf+p).length>60){ chunks.push(buf); buf=p; } else { buf+=p; }
    }
    if(buf) chunks.push(buf);
    return chunks.join("\n\n");
  }

  // 1æ–‡å­—ã”ã¨ã®ç”»æ•°ï¼ˆè¾æ›¸â†’fallbackï¼‰
  function strokeOf(ch, fallback){
    if (ch in STROKES) return STROKES[ch];
    if (typeof fallback === "number" && fallback>0) return fallback;
    return null; // ä¸æ˜
  }

  // å§“åã‹ã‚‰ surname/given ã‚’åˆ†é›¢ï¼ˆå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹/åŠè§’ã‚¹ãƒšãƒ¼ã‚¹å¯¾å¿œï¼‰
  function splitName(surname, full){
    const clean = String(full).replace(/\s+/g,"");
    const sChars = Array.from(surname);
    let rest = clean.startsWith(surname) ? clean.slice(sChars.length) : clean;
    const gChars = Array.from(rest);
    return { sChars, gChars };
  }

  // AIè¿”å´ã® breakdown ã‚’è¾æ›¸ã§ã€Œä¸Šæ›¸ãè£œæ­£ã€ã—ã€äº”æ ¼ã‚’å†è¨ˆç®—
  function recalcWithDictionary(candidate, inputSurname){
    const { sChars, gChars } = splitName(inputSurname, candidate.name||"");
    // AIã® breakdown ã‹ã‚‰ fallback å€¤ã‚’æ‹¾ãˆã‚‹ã‚ˆã†ãƒãƒƒã‚·ãƒ¥åŒ–
    const aiBD = {};
    const bdS = candidate?.strokes?.surname?.breakdown || [];
    const bdG = candidate?.strokes?.given?.breakdown || [];
    [...bdS, ...bdG].forEach(b=>{
      const ch = Array.isArray(b) ? String(b[0]) : String(b?.char||"");
      const n  = Array.isArray(b) ? Number(b[1]) : Number(b?.count);
      if(ch) aiBD[ch]=isFinite(n)?n:null;
    });

    const sBD = sChars.map(ch => ({char:ch, count: strokeOf(ch, aiBD[ch])}));
    const gBD = gChars.map(ch => ({char:ch, count: strokeOf(ch, aiBD[ch])}));

    const sum = arr => arr.reduce((n,x)=>n + (Number(x.count)||0), 0);
    const sSum = sum(sBD);
    const gSum = sum(gBD);
    const total = sSum + gSum;

    // äº”æ ¼ï¼ˆäº”æ ¼æ³•ãƒ»æ–°å­—ä½“ãƒ»éœŠæ•°ãªã—ï¼‰
    const lastSurname = sBD[sBD.length-1]?.count || 0;
    const firstGiven  = gBD[0]?.count || 0;
    const tenkaku = sSum;
    const chigaku  = gSum;       // åœ°æ ¼
    const jinkaku  = lastSurname + firstGiven;
    const soukaku  = total;
    const gaikaku  = Math.max(soukaku - jinkaku, 0);

    return {
      ...candidate,
      __calc: {
        sBD, gBD, sSum, gSum, total,
        gokaku: { tenkaku, jinkaku, chikaku: chigaku, gaikaku, soukaku }
      }
    };
  }

  function renderBreakdownFromCalc(calc){
    const all = [...calc.sBD, ...calc.gBD];
    if(!all.length) return "-";
    return all.map(x => `${x.char}:${x.count ?? "?"}`).join(" / ");
  }

  function asText(candidate){
    const f = candidate?.fortune || {};
    const calc = candidate.__calc;
    return [
      `ã€åå‰ã€‘${candidate.name}ï¼ˆèª­ã¿: ${candidate.reading||"-"}ï¼‰`,
      `ã€ã‚³ãƒ”ãƒ¼ã€‘${candidate.copy||"-"}`,
      `ã€ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã€‘${(candidate.story||"-").replace(/\s+$/,"")}`,
      `ã€äº”æ ¼ï¼ˆè£œæ­£ï¼‰ã€‘å¤©:${calc.gokaku.tenkaku} / äºº:${calc.gokaku.jinkaku} / åœ°:${calc.gokaku.chikaku} / å¤–:${calc.gokaku.gaikaku} / ç·:${calc.gokaku.soukaku}`,
      `ã€é‹å‹¢ï¼ˆAIï¼‰ã€‘ç·åˆ:${f?.luck?.overall||"-"} / ä»•äº‹:${f?.luck?.work||"-"} / æ‹æ„›:${f?.luck?.love||"-"} / å¥åº·:${f?.luck?.health||"-"}`,
      `ã€ç”»æ•°ï¼ˆè£œæ­£ï¼‰ã€‘å§“:${calc.sSum} / å:${calc.gSum} / ç·ç”»:${calc.total} / å†…è¨³:${renderBreakdownFromCalc(calc)}`
    ].join("\n");
  }

  async function generate(){
    const surname = document.getElementById("surname").value.trim();
    const gender  = document.getElementById("gender").value;
    const concept = document.getElementById("concept").value.trim();
    const debug   = document.getElementById("debugMode").checked;
    const endpoint = debug ? "/api/generate?debug=1" : "/api/generate";

    if(!surname || !concept){
      alert("è‹—å­—ã¨å¸Œæœ›ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const status = document.getElementById("status");
    const policyLine = document.getElementById("policyLine");
    const results = document.getElementById("results");
    status.textContent = "è¨ºæ–­ä¸­â€¦";
    policyLine.textContent = "";
    results.innerHTML = "";

    try{
      const res = await fetch(endpoint,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ surname, gender, concept })
      });
      const data = await res.json();
      console.log("[/api/generate response]", data);

      if(!data || !Array.isArray(data.candidates)){
        status.textContent = "ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        return;
      }

      const ryuha = data?.policy?.ryuha || "äº”æ ¼æ³•ï¼ˆæ–°å­—ä½“ãƒ»éœŠæ•°ãªã—ï¼‰";
      const notes = data?.policy?.notes || "ç¾ä»£çš„ã§èª­ã¿ã‚„ã™ã„è¡¨è¨˜ã‚’å„ªå…ˆ";
      policyLine.textContent = `æµæ´¾/è¨ˆç®—æ–¹å¼ï¼š${ryuha} ï¼ æ–¹é‡ï¼š${notes}ï¼ˆç”»æ•°ã¨äº”æ ¼ã¯è¾æ›¸ã§è£œæ­£è¡¨ç¤ºï¼‰`;

      // â† ã“ã“ã§å…¨å€™è£œã«è¾æ›¸è£œæ­£ã‚’é©ç”¨
      const fixed = data.candidates.map(c => recalcWithDictionary(c, surname));

      results.innerHTML = fixed.map((c, idx) => {
        const f = c.fortune || {};
        const calc = c.__calc;
        return `
          <div class="card" data-idx="${idx}">
            <h3 class="name">${c.name || "-"}</h3>
            <p class="reading">èª­ã¿ï¼š${textOrDash(c.reading)}</p>
            <p class="copy">${c.copy ? c.copy : ""}</p>
            <p class="story">${paragraphize(c.story)}</p>

            <div class="subttl">å§“ååˆ¤æ–­ï¼ˆè£œæ­£è¡¨ç¤ºï¼‰</div>
            <table>
              <tr><th>å¤©æ ¼</th><td>${calc.gokaku.tenkaku}</td><th>äººæ ¼</th><td>${calc.gokaku.jinkaku}</td></tr>
              <tr><th>åœ°æ ¼</th><td>${calc.gokaku.chikaku}</td><th>å¤–æ ¼</th><td>${calc.gokaku.gaikaku}</td></tr>
              <tr><th>ç·æ ¼</th><td>${calc.gokaku.soukaku}</td><th>ç·åˆé‹</th><td>${luckBadge(f?.luck?.overall)}</td></tr>
              <tr><th>ğŸ’¼ ä»•äº‹é‹</th><td>${luckBadge(f?.luck?.work)}</td><th>â¤ï¸ æ‹æ„›é‹</th><td>${luckBadge(f?.luck?.love)}</td></tr>
              <tr><th>ğŸŒ¸ å¥åº·é‹</th><td>${luckBadge(f?.luck?.health)}</td><th>å‚™è€ƒ</th><td>${textOrDash(f.note)}</td></tr>
            </table>

            <div class="subttl">ç”»æ•°è¨ºæ–­ï¼ˆè£œæ­£è¡¨ç¤ºï¼‰</div>
            <table>
              <tr><th>å§“ åˆè¨ˆ</th><td>${calc.sSum}</td><th>å åˆè¨ˆ</th><td>${calc.gSum}</td></tr>
              <tr><th>ç·ç”»</th><td colspan="3">${calc.total}</td></tr>
              <tr><th>å†…è¨³</th><td colspan="3">${renderBreakdownFromCalc(calc)}</td></tr>
            </table>

            <div class="actions">
              <button class="btn" onclick="copyCard(${idx})">ã“ã®å€™è£œã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
          </div>
        `;
      }).join("");

      status.textContent = debug ? "ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰ãƒ€ãƒŸãƒ¼çµæœã‚’è¡¨ç¤ºä¸­ã€‚" : "ç”Ÿæˆå®Œäº†ã€‚";
      window.__lastCandidates = fixed;

    }catch(err){
      console.error(err);
      status.textContent = "ã‚µãƒ¼ãƒã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
    }
  }

  function copyCard(idx){
    const cand = (window.__lastCandidates || [])[idx];
    if(!cand) return;
    const text = asText(cand);
    navigator.clipboard.writeText(text).then(()=>{
      alert("å€™è£œã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
    }).catch(()=>{
      prompt("ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼š", text);
    });
  }
</script>
</body>
</html>
